---
title: "Read h5"
author: "CZ"
date: "4/1/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#hdf5
```


#hdf5r
```{r}
library(hdf5r)
library(dplyr)
library(cranium)
library(broom)
library(tidyverse)


file <- "AT_wildtype_101_Probabilities.h5"

#################
#function
read_h5 <- function(file, name = NULL, ...) {
  if("hdf5" %in% (.packages())){
    objs <- rhdf5::h5ls(file) %>%
      dplyr::filter(otype == "H5I_DATASET")
    if (is.null(name)) {
      # take the first HDF5 dataset
      name <- objs$name[1]
    }
    x <- rhdf5::h5read(file, name, ...)
    if (length(dim(x)) > 3) {
      # take the second image
      x <- x[2,,,]
    }
    class(x) <- append("brain", class(x))
    return(x)
  }
  if("hdf5r" %in% (.packages())){
    file.h5 <- H5File$new(file, mode="r")
    brain <- file.h5[["exported_data"]]
    x <- brain[2,,,]
  }
  class(x) <- append("brain", class(x))
  return(x)
}

tidy.brain <- function(x, threshold = 0.9, ...) {
  res <- x %>%
    as.data.frame.table() %>%
    mutate(x = as.integer(Var1) * 0.13,
           y = as.integer(Var2) * 0.13,
           z = as.integer(Var3) * 0.21) %>%
    select(x, y, z, Freq) %>%
    tibble::as_tibble() %>%
    mutate(gray_val = gray(1 - Freq)) %>%
    #    filter(Freq > 0) %>%
    filter(Freq > threshold)
  class(res) <- append("tbl_brain", class(res))
  return(res)
}


tidy_brain <- file %>%
  read_h5() %>%
  tidy()
###############

```



#read_h5
```{r}
read_h5 <- function(file, name = NULL, ...) {
  objs <- rhdf5::h5ls(file) %>%
    dplyr::filter(otype == "H5I_DATASET")
  if (is.null(name)) {
    # take the first HDF5 dataset
    name <- objs$name[1]
  }
  x <- rhdf5::h5read(file, name, ...)
  if (length(dim(x)) > 3) {
    # take the second image
    x <- x[2,,,]
  }
  else {
    file.h5 <- H5File$new(file, mode="r")
    brain <- file.h5[["exported_data"]]
    x <- brain[2,,,]
  }
  class(x) <- append("brain", class(x))
  return(x)
}

read_h5()
```

#tidy
```{r}

```
