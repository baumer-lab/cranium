---
title: "model_eval_2CZ"
author: "CZ"
date: "4/13/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(hdf5r)
library(dplyr)
library(readr)
library(rlang)
library(cranium)
library(broom)
library(tidyverse)
library(gridExtra)
library(mosaic)

#new packages
library(sjstats)
library(grDevices)
```

# You Too 
```{r}
threshold_yt <- read_csv("visualization_results/threshold_yt_all_final.csv")%>%
  select(-X1)

threshold_yt$Sample_id <- as.character(threshold_yt$Sample_id)
threshold_yt$threshold <- as.character(threshold_yt$threshold )

#lineplot for each sample 
ggplot(data = threshold_yt, aes(x = threshold, y = adj.r.squared, group=Sample)) + 
  geom_line()  + 
  aes(colour = Sample) + theme(legend.position = "right") + labs(title = "Threshold trend sample -- Mutant")+
  theme(axis.text.x = element_text(angle = 60, hjust = 1))



#Number of signals left in for each threshold 
num_signal_tb <- threshold_yt%>%
  group_by(threshold)%>%
  summarize(min=min(num.signal),mean_num_signal = mean(num.signal), max=max(num.signal), sd=sd(num.signal))

#boxplot for each threshold y:r2
ggplot(data =threshold_yt, aes(x = threshold, y = adj.r.squared)) +
  geom_boxplot()  + 
  labs(title = "Optimal threshold for You Too Mutatnt type")
```

#Mode fit comparison: before PCA and after PCA (adj.r.square)
```{r}

threshold_wt_all_0.9 <- threshold_wt_all%>%
  filter(threshold == 0.90)

#t test
tttest_pca <- t.test(threshold_wt_all_0.9$adj.r.squared.original, threshold_wt_all_0.9$adj.r.squared, paired = TRUE, alternative = "two.sided")
tttest_pca

# printing the p-value
tttest_pca$p.value


#Re orientation improved model fit
ggplot(data = threshold_wt_all, aes(x = adj.r.squared.original, y = adj.r.squared)) + geom_point()  + labs(title = "Adjusted R square before and after reorientation")+ 
  scale_y_continuous(limits=c(0.2,1))

favstats(threshold_wt_all_0.9$adj.r.squared)
favstats(threshold_wt_all_0.9$adj.r.squared.original)

table(threshold_yt_all_final$threshold)
```



#Mode fit comparison: before PCA and after PCA (adj.r.square) -- Youtoo
```{r}
threshold_yt_all_0.8 <- threshold_yt_all_final%>%
  filter(threshold == 0.80)

#t test
tttest_pca <- t.test(threshold_yt_all_0.8$adj.r.squared.original, threshold_yt_all_0.8$adj.r.squared, paired = TRUE, alternative = "two.sided")
tttest_pca

# printing the p-value
tttest_pca$p.value

#Re orientation improved model fit
ggplot(data = threshold_yt_all_final, aes(x = adj.r.squared.original, y = adj.r.squared)) + geom_point()  + labs(title = "Adjusted R square before and after reorientation for You Too Mutant")

favstats(threshold_yt_all_0.8$adj.r.squared)
favstats(threshold_yt_all_0.8$adj.r.squared.original)
```

# Finding optimal threshold
You Too
```{r}
#find optimal threshold
optimal_threshold <- data.frame()
m <- list()
for (i in (1:35)){
  m <- threshold_yt%>%
  filter(Sample_id==i)%>%
  filter(adj.r.squared == max(adj.r.squared))%>%
    mutate(optimal_threshold = threshold)%>%
    select(-threshold)
  optimal_threshold <- rbind(optimal_threshold,m)
}

#optimal threhsold table
table(optimal_threshold$optimal_threshold)

threshold_0.92 <- threshold_yt%>%
  filter(threshold==0.92)

threshold_yt$threshold <- as.character(threshold_yt$threshold)
#mplot(threshold_yt)
ggplot(data = threshold_yt, aes(x = threshold, y = adj.r.squared)) + geom_boxplot()  + labs(title = "Optimal threshold--Adjusted R sqrae--Mutant (YouToo)")

ggplot(data = threshold_yt, aes(x = threshold, y = RMSE)) + geom_boxplot()  + labs(title = "Optimal threshold--RMSE--Mutant (YouToo)")


ggplot(data = threshold_yt, aes(x = threshold, y = adj.r.squared)) + geom_point()  + facet_wrap(~Sample, ncol = 5) + labs(title = "Sample level optimal threshold--r^2--Mutate")+ theme(axis.text.x = element_text(angle = 90, hjust = 1))
```


```{r} 
table(threshold_yt$threshold)

yt_goodfit <- threshold_yt %>%
  filter(threshold == 0.8)%>%
  filter(adj.r.squared > 0.5 & RMSE< 6)


yt_badfit <- threshold_yt %>%
  filter(threshold == 0.8)%>%
  filter(adj.r.squared < 0.5 | RMSE> 6)


```


# Plot: You Too.
threshold = 0.5
```{r eval=FALSE, include=FALSE}
path = "Sample/YouToo"
file_names <- list.files(path, pattern=".h5", full.names=TRUE)

  
for (i in (1:length(file_names))){
  name <- sub("_Probabilities.h5", "", file_names[i])
  name <- sub("Sample/YouToo/", "Youtoo_", name)

  png(filename = paste("visualization_results/youtoo_plots_0.5/", name, ".png", sep= ""))
    mytitle = paste("plot_",name)
    file_names[i] %>%
    read_h5()%>%
    tidy(type="youtoo", threshold.n = 0.5)%>%
    reorient()%>%
    plot2d(title=name)
  dev.off()
}
```

threshold = 0.6
```{r eval=FALSE, include=FALSE}
path = "Sample/YouToo"
file_names <- list.files(path, pattern=".h5", full.names=TRUE)

  
for (i in (1:length(file_names))){
  old <- Sys.time()
  name <- sub("_Probabilities.h5", "", file_names[i])
  name <- sub("Sample/YouToo/", "Youtoo_", name)

  png(filename = paste("visualization_results/youtoo_plots_0.6/", name, ".png", sep= ""))
    mytitle = paste("plot_",name)
    file_names[i] %>%
    read_h5()%>%
    tidy(type="youtoo", threshold.n = 0.6)%>%
    reorient()%>%
    plot2d(title=name)
  dev.off()
  new <- Sys.time() - old # calculate difference
    print(new) # print in nice format
}
```


threshold = 0.8
```{r eval=FALSE, include=FALSE}
path = "Sample/YouToo"
file_names <- list.files(path, pattern=".h5", full.names=TRUE)

  
for (i in (1:length(file_names))){
  old <- Sys.time()
  name <- sub("_Probabilities.h5", "", file_names[i])
  name <- sub("Sample/YouToo/", "Youtoo_", name)

  png(filename = paste("visualization_results/youtoo_plots_0.8/", name, ".png", sep= ""))
    mytitle = paste("plot_",name)
    file_names[i] %>%
    read_h5()%>%
    tidy(type="youtoo", threshold.n = 0.8)%>%
    reorient()%>%
    plot2d(title=name)
  dev.off()
  new <- Sys.time() - old # calculate difference
    print(new) # print in nice format
}
```


threshold = 0.92
```{r eval=FALSE, include=FALSE}
path = "Sample/YouToo"
file_names <- list.files(path, pattern=".h5", full.names=TRUE)

  
for (i in (1:length(file_names))){
  old <- Sys.time()
  name <- sub("_Probabilities.h5", "", file_names[i])
  name <- sub("Sample/YouToo/", "Youtoo_", name)

  png(filename = paste("visualization_results/youtoo_plots_0.92/", name, ".png", sep= ""))
    mytitle = paste("plot_",name)
    file_names[i] %>%
    read_h5()%>%
    tidy(type="youtoo", threshold.n = 0.92)%>%
    reorient()%>%
    plot2d(title=name)
  dev.off()
  new <- Sys.time() - old # calculate difference
    print(new) # print in nice format
}
```
