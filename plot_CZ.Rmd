---
title: "Plot"
author: "CZ"
date: "4/1/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#hdf5
```


#hdf5r
```{r}
library(hdf5r)
library(dplyr)
library(rlang)
library(BiocInstaller)
#biocLite("rhdf5")
library(rhdf5)
#devtools::install_github("beanumber/cranium")
library(cranium)
library(broom)
library(tidyverse)
library(gridExtra)
library(mosaic)
```

# Edited functions
```{r}
read_h5 <- function(file, name = NULL, ...) {
  if("rhdf5" %in% (.packages())){
    objs <- rhdf5::h5ls(file) %>%
      dplyr::filter(otype == "H5I_DATASET")
    if (is.null(name)) {
      # take the first HDF5 dataset
      name <- objs$name[1]
    }
    x <- rhdf5::h5read(file, name, ...)
    if (length(dim(x)) > 3) {
      # take the second image
      x <- x[2,,,]
    }
    class(x) <- append("brain", class(x))
    return(x)
  }
  if("hdf5r" %in% (.packages())){
    file.h5 <- H5File$new(file, mode="r")
    brain <- file.h5[["exported_data"]]
    x <- brain[2,,,]
  }
  class(x) <- append("brain", class(x))
  return(x)
}


plot2d <- function(x, show_max = FALSE, title...) UseMethod("plot2d")

#' @export
#' @rdname plot2d

plot2d.brain <- function(x, show_max = FALSE, ...) {
  tidy_brain <- tidy(x)
  plot2d(tidy_brain, show_max = FALSE, ...)
}

#' @export
#' @importFrom gridExtra grid.arrange
#' @rdname plot2d
plot2d.tbl_brain <- function(x, title, show_max = FALSE, ...) {
  gridExtra::grid.arrange(
    plot2d_plane(x, plane = c("x", "z"), show_max, ...),
    plot2d_plane(x, plane = c("x", "y"), show_max, ...),
    plot2d_plane(x, plane = c("y", "z"), show_max, ...),
    nrow = 1,
    top = title
  )
}

#' @export
#' @importFrom rlang !!
#' @import ggplot2
#' @rdname plot2d
plot2d_plane <- function(x, plane = c("x", "z"), show_max = FALSE, ...) {
  depth <- setdiff(c("x", "y", "z"), plane)
  depth_var <- rlang::sym(depth)
  
  gg_data <- x %>%
    group_by(.dots = plane) %>%
    summarize(N = n(), min_freq = min(Freq),
              avg_depth = mean(!! depth_var, na.rm = TRUE),
              max_depth = max(!! depth_var, na.rm = TRUE))
  
  if (show_max) {
    plot_var <- "max_depth"
  } else
    plot_var <- "avg_depth"
  labels <- data.frame(var = c("x", "y", "z"),
                       label = c("Lateral (x, microns)",
                                 "Anterior/Posterior (y, microns)",
                                 "Dorsal/Ventral (z, microns)")) %>%
    filter(var %in% plane)
  titles <- data.frame(depth_var = c("x", "y", "z"),
                       title = c("Side View", "Front View", "Top View"))
  ggplot(gg_data, aes_string(x = plane[1], y = plane[2], color = plot_var), ...) +
    geom_point(alpha = 0.1, size = 0.5) +
    geom_smooth(method = "lm", formula = y ~ I(x^2) + x, color = "red") +
    geom_smooth(method = "lm", color = "red") +
    annotate("text", x = 0, y = 0, label = "origin", size = 5) +
    annotate("text", x = 0, y = 0,
             label = paste0("min_prob: ", round(min(pull(ungroup(gg_data), "min_freq")), 2))) +
    scale_color_continuous(guide = FALSE) +
    scale_x_continuous(filter(labels, var == plane[1])$label) +
    scale_y_continuous(filter(labels, var == plane[2])$label) +
    ggtitle(filter(titles, depth_var == depth)$title)
}
```



```{r}

#ls <- c("W_101", "W_102", "W_104", "You_Too_01", "You_Too_02", "You_Too_03", "You_Too_04","You_Too_06", "You_Too_21")

ls <- c("W_101", "W_102", "You_Too_01", "You_Too_02")

file_ls =c("0")

file
for (i in (1:length(ls))) {
  file_ls[i] = paste("file", ls[i], sep='')
}

file_ls

file_ls[1]<- "Sample/AT_wildtype_101_Probabilities.h5"
file_ls[2] <-  "Sample/AT_wildtype_102_Probabilities.h5"
#file_ls[3] <-  "Sample/AT_wildtype_104_Probabilities.h5"
file_ls[3] <- "Sample/AT_01_Probabilities.h5"
file_ls[4] <- "Sample/AT_02_Probabilities.h5"
#file_ls[6] <- "Sample/AT_03_Probabilities.h5"
#file_ls[7] <- "Sample/AT_04_Probabilities.h5"
#file_ls[8] <- "Sample/AT_06_Probabilities.h5"
#file_ls[9] <- "Sample/AT_21_Probabilities.h5"


file_ls

tidy_brain_ls <- list()

for (i in (1:length(ls))) {
  tidy_brain_ls[[i]] <- file_ls[i] %>%
  read_h5() %>%
  tidy()
}


```


```{r}
sample1<- tidy_brain_ls[[1]]
sample1

#mplot(sample1)



sample3<- tidy_brain_ls[[3]]
sample3
mplot(sample1)



ggplot( data = sample1, aes(x = Freq)) + geom_density(adjust = 0.4) + labs(title = "Wild type") 

ggplot( data = sample1, aes(x = Freq)) + geom_density(adjust = 0.4) + labs(title = "You too") 


```



```{r}
for (i in (1:length(ls))) {
  tidy_brain_ls[[i]] <- file_ls[i] %>%
  read_h5() %>%
  tidy()
}

#Reorient
ro_brain_ls<-tidy_brain_ls%>%
lapply(reorient)

```




# Test plot
```{r}
plotlist <- list()
for (i in (4:4)){
  plotlist[[i]] <- plot2d(tidy_brain_ls[[i]], title=paste("Sample", ls[i]))
   # plot(plotlist[[i]])
   # dev.off
 # decorate3d
}

```

# All plots
```{r}


plotlist <- list()
for (i in (1:length(file_ls))){
  plotlist[[i]] <- plot2d(tidy_brain_ls[[i]],title=paste("Sample", ls[i]))
   # plot(plotlist[[i]])
   # dev.off
}



plotlist <- list()
for (i in (1:length(file_ls))){
  plotlist[[i]] <- plot2d(ro_brain_ls[[i]],title=paste("Sample", ls[i]))
   # plot(plotlist[[i]])
   # dev.off
}
#do.call(grid.arrange, c(plotlist, ncol = 3))

```



