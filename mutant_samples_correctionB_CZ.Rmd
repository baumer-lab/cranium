---
title: "Mutant sample correction B"
author: "Crystal Zang"
date: "5/1/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(hdf5r)
library(dplyr)
library(readr)
library(rlang)
library(cranium)
library(broom)
library(tidyverse)
library(gridExtra)
library(mosaic)

#new packages
library(sjstats)
library(grDevices)
library(skimr)
library(gmodels)
library(spatstat.utils)
library(REdaS)
```

#correct errorB function
```{r}
correct_errorB.tbl_brain <- function(data, type = "wildtype", threshold.n=0.9, a = 1){
 # ro_tidy_brain <- data%>%
 #   tidy(type, threshold = threshold.n)%>%
  #  reorient()
  
  #extract quadratic model coefficients from xy plane 
  ro_model <- attr(data, "quad_mod_xz")
  quad.coeff = round((summary(ro_model)$coefficients["I(x^2)", "Estimate"]), 4)  #a
  x.coeff = round((summary(ro_model)$coefficients["x", "Estimate"]), 4)#b
  intercept = round((summary(ro_model)$coefficients["(Intercept)", "Estimate"]), 4) #c
  # y intercept
  y_intercept <- intercept
  # x intercept
  x_intercept <- (-x.coeff + sqrt(x.coeff^2 - 4* quad.coeff * intercept))/ (2*quad.coeff)
  
  #vertex (x)
#  vertex.x <- -x.coeff/(2*quad.coeff)
 # vertex.y <- quad.coeff * (vertex.x ^ 2) + x.coeff * vertex.x + intercept
 # vertex <- c(vertex.x, vertex.y)
  
  #slope of the line connecting m and n
  slope <- abs(y_intercept/x_intercept)
  #slope to angle (radian)
  rotation_angle_radian <- a * atan(slope)
  #radian to degree
  rotation_angle_degree <- rad2deg(rotation_angle_radian)
  
 
  matrix.x <- diag(3)
  matrix.x[2,2] <- cos(rotation_angle_radian)
  matrix.x[2,3] <- -sin(rotation_angle_radian)
  matrix.x[3,2] <- sin(rotation_angle_radian)
  matrix.x[3,3] <- cos(rotation_angle_radian)
  
  data.matrix<-data%>%
    select(x,y,z)%>%
    as.matrix()
  
  data_freq_gray<- data%>%
    select(Freq,gray_val)
  
  C <- data.matrix %*% matrix.x %>%
    tibble::as_tibble() %>%
    bind_cols(data_freq_gray)
  
  names(C) <- names(data)
  
  class(C) <- append("tbl_brain", class(C)) 
  
  return(C)
}
```


# First, identify samples that have errorB
```{r}
curve_yt_0_6 <- read_csv("correction_results/curve_yt_0.6.csv")%>%
  select(-X1)%>%
  mutate(type = "Mutant")

outlier_range <- c(-0.00202, 0.00182)
curve_yt_0_6 <- curve_yt_0_6 %>%
  mutate(is_errorB = if_else(inside.range(quad.slope_xz, outlier_range) == TRUE, "no errorB", "is error B"))

errorB_sample <- curve_yt_0_6 %>%
  filter(is_errorB == "is error B")

vector_errorB_id <- errorB_sample %>%
  pull(Sample_id)

path = "Sample/YouToo"
file_names <- list.files(path, pattern=".h5", full.names=TRUE)

correctionB_num <- numeric(nrow(errorB_sample))

########## for loop: 
for (i in (1: nrow(errorB_sample))){
  id <- vector_errorB_id[i]
  tidy_brain <- read_h5(file_names[id])%>%
    tidy(threshold.n = 0.6)
  if (is_errorA(tidy_brain) == TRUE){
    ro_tidy_brain <- reorient(tidy_brain, correctionA = TRUE)
  }else{
    ro_tidy_brain <- reorient(tidy_brain)
  }
  
  #first check
  if (is_errorB(ro_tidy_brain) == TRUE){
    c.B.ro_tidy_brain <- correct_errorB.tbl_brain(ro_tidy_brain, threshold.n = 0.6)
    
      ##second check
      if(is_errorB(c.B.ro_tidy_brain) == TRUE){
          c2.B.ro_tidy_brain <- correct_errorB.tbl_brain(ro_tidy_brain, threshold.n = 0.6, a = 2)
             ##third check
              if(is_errorB(c2.B.ro_tidy_brain) == TRUE){
                  c3.B.ro_tidy_brain <- correct_errorB.tbl_brain(ro_tidy_brain, threshold.n = 0.6, a = 3)                 
                    ##forth check
                    if(is_errorB(c3.B.ro_tidy_brain) == TRUE){
                    c4.B.ro_tidy_brain <- correct_errorB.tbl_brain(ro_tidy_brain, threshold.n = 0.6, a = 4)
                    
                        ##fifth check
                        if(is_errorB(c4.B.ro_tidy_brain) == TRUE){
                        c5.B.ro_tidy_brain <- correct_errorB.tbl_brain(ro_tidy_brain, threshold.n = 0.6, a = 5)                     
                              ##sixed check
                               if(is_errorB(c5.B.ro_tidy_brain) == TRUE){
                                 c6.B.ro_tidy_brain <- correct_errorB.tbl_brain(ro_tidy_brain, threshold.n = 0.6, a = 6)
                    
                    
                    
          
                    
                    correctionB_num[i] <- 99  # 99 means upper limit, not performing mroe correction
                               } 
                              #end after the sixed correction
                              else{ 
                          correctionB_num[i]  <- 6
                           }
                        }
                    
                    
                    #end after the fifth correction
                    else{ 
                        correctionB_num[i]  <- 5
                    }
                  }
                    #end after the forth correction
                   else{
                        correctionB_num[i]  <- 4
                    }
                  
                }
             #end after the third correction
              else{
              correctionB_num[i]  <- 3
                }
          
      }
     #end after the second correction
     else{
          correctionB_num[i]  <- 2

      }
  }
  #end after the first correction
  else{ 
    correctionB_num[i]  <- 1
  }
}
  



```

```{r}
for (i in (1: nrow(errorB_sample))){
  id <- vector_errorB_id[i]
  tidy_brain <- read_h5(file_names[id])%>%
    tidy(threshold.n = 0.6)
  if (is_errorA(tidy_brain) == TRUE){
    ro_tidy_brain <- reorient(tidy_brain, correctionA = TRUE)
  }else{
    ro_tidy_brain <- reorient(tidy_brain)
  }
  
  #first check
  if (is_errorB(ro_tidy_brain) == TRUE){
    c.B.ro_tidy_brain <- correct_errorB.tbl_brain(ro_tidy_brain, threshold.n = 0.6)
  }else{
    out <- ro_tidy_brain
  }
  ##second check
  if(is_errorB(c.B.ro_tidy_brain) == TRUE){
    c2.B.ro_tidy_brain <- correct_errorB.tbl_brain(ro_tidy_brain, threshold.n = 0.6, a = 2)
  }else{
    out<-c.B.ro_tidy_brain
  }
  
  ##third check
  if(is_errorB(c2.B.ro_tidy_brain) == TRUE){
    c3.B.ro_tidy_brain <- correct_errorB.tbl_brain(ro_tidy_brain, threshold.n = 0.6, a = 3)
  }else{
    out<-c2.B.ro_tidy_brain
  }
  
  ##forth check
  if(is_errorB(c3.B.ro_tidy_brain) == TRUE){
    c4.B.ro_tidy_brain <- correct_errorB.tbl_brain(ro_tidy_brain, threshold.n = 0.6, a = 4)
  }else{
    out<-c3.B.ro_tidy_brain
  }
  
}
```




