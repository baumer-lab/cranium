---
title: "alignment_error_function_CZ"
author: "Crystal Zang"
date: "4/22/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(hdf5r)
library(dplyr)
library(readr)
library(rlang)
library(cranium)
library(broom)
library(tidyverse)
library(gridExtra)
library(mosaic)

#new packages
library(sjstats)
library(grDevices)
```



```{r}
#Model evaluation
#Requires: brain class type.
correctionA.brain<- function(data, type="wildtype", threshold.n=0.9){
  ro_tidy_brain <- data%>%
    tidy(type, threshold = threshold.n)%>%
    reorient()
  ro_model <- attr(ro_tidy_brain, "quad_mod")  #model applied on reoriented data
  quad.coeff = round((summary(ro_model)$coefficients["I(x^2)", "Estimate"]), 4)

  if (quad.coeff <0){
  message("Y Axis is flipped")
  sum_tb <- sum_tb%>%
    mutate(y_flipped = 1)
}else{
  message("Correct alignment")
  sum_tb <- sum_tb%>%
    mutate(y_flipped = 0)
}
  return(sum_tb)
}


#test
correctionA.brain(data, type="wildtype", threshold.n=0.9)
```



```{r}
#before callying the function
path = "Sample/WildType"
file_names <- list.files(path, pattern=".h5", full.names=TRUE)

#input
data <- read_h5(file_names[11])

ro_tidy_brain <- data%>%
    tidy("wildtype", threshold = 0.6) %>%
    reorient()

ro_model <- attr(ro_tidy_brain, "quad_mod")  #model applied on reoriented data
quad.coeff =round((summary(ro_model)$coefficients["I(x^2)", "Estimate"]), 4)
sum_tb=as.data.frame(quad.coeff)

if (quad.coeff <0){
  message("Y Axis is flipped")
  sum_tb <- sum_tb%>%
    mutate(y_flipped = 1)
}else{
  message("Correct alignment")
  sum_tb <- sum_tb%>%
    mutate(y_flipped = 0)
}
  return(quad.coeff)
```


```{r}
correctionA_wt_0.9 <- read_csv("correction_results/correctionA_wt_0.9.csv")%>%
  select(-X1)

path = "Sample/WildType"
file_names <- list.files(path, pattern=".h5", full.names=TRUE)


correctionA_wt_0.9_y <- correctionA_wt_0.9 %>%
  filter(y_flipped == 1)
for (i in (1:length(correctionA_wt_0.9_y))){
  j=Sample_id
  c_ro_tidy_brain <- file_names[j]%>%
    read_h5()%>%
    tidy(type, threshold = threshold.n)%>%
    reorient(correction=TRUE)
  
}



ro_tidy_brain<-file_names[j]%>%
    read_h5()%>%
    tidy(type, threshold = threshold.n)%>%
    reorient()

data<-read_h5(file_names[20])
correctionA.brain(data)

```

