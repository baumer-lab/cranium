---
title: "alignment_error_function_CZ"
author: "Crystal Zang"
date: "4/22/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(hdf5r)
library(dplyr)
library(readr)
library(rlang)
library(cranium)
library(broom)
library(tidyverse)
library(gridExtra)
library(mosaic)

#new packages
library(sjstats)
library(grDevices)
library(skimr)
```


# Error A function 
```{r}
#Model evaluation
#Requires: brain class type.
errorA.brain<- function(data, type="wildtype", threshold.n=0.9){
  ro_tidy_brain <- data%>%
    tidy(type, threshold = threshold.n)%>%
    reorient()
  ro_model <- attr(ro_tidy_brain, "quad_mod")  #model applied on reoriented data
  quad.coeff = round((summary(ro_model)$coefficients["I(x^2)", "Estimate"]), 4)

  if (quad.coeff <0){
  message("Y Axis is flipped")
  sum_tb <- sum_tb%>%
    mutate(y_flipped = 1)
}else{
  message("Correct alignment")
  sum_tb <- sum_tb%>%
    mutate(y_flipped = 0)
}
  return(sum_tb)
}
```


# ErrorA function test sample
```{r}
path = "Sample/WildType"
file_names <- list.files(path, pattern=".h5", full.names=TRUE)

#input
data <- read_h5(file_names[10])

class(data)

errorA.brain(data, type="wildtype", threshold.n=0.6)

c.brain<-correctionA.brain(data, type="wildtype", threshold.n=0.6)
```


# Compare error A for two wt thresholds:
0.9: #error = 6
0.6: #error = 5
```{r}
correctionA_wt_0.9 <- read_csv("correction_results/correctionA_wt_0.9.csv")%>%
  select(-X1)
correctionA_wt_0.6 <- read_csv("correction_results/correctionA_wt_0.6.csv")%>%
  select(-X1)

path = "Sample/WildType"
file_names <- list.files(path, pattern=".h5", full.names=TRUE)


correctionA_wt_0.9_y <- correctionA_wt_0.9 %>%
  filter(y_flipped == 1)
for (i in (1:length(correctionA_wt_0.9_y))){
  j=Sample_id
  c_ro_tidy_brain <- file_names[j]%>%
    read_h5()%>%
    tidy(type, threshold = threshold.n)%>%
    reorient(correctionA=TRUE)
}

ro_tidy_brain<-file_names[j]%>%
    read_h5()%>%
    tidy(type, threshold = threshold.n)%>%
    reorient()

data<-read_h5(file_names[20])

errorA.brain(data)
class(data)
```


# Error B 
```{r}
path = "Sample/WildType"
file_names <- list.ficles(path, pattern=".h5", full.names=TRUE)

#ONE SAMPLE
data<-read_h5(file_names[29])%>%
  tidy(threshold=0.6)
plot2d(data)
errorB<-data%>%
  skim(z)%>%
  select(stat, formatted)%>%
  spread(stat, formatted)


#LOOP
path = "Sample/WildType"
file_names <- list.files(path, pattern=".h5", full.names=TRUE)

errorB_df <- data.frame()

#apply qmodel to all sample, testing for each threshold
for (i in (1:length(file_names))){
    name <- sub("_Probabilities.h5", "", file_names[i])
    name <- sub("Sample/WildType/", "WildType_", name) 
    m <- file_names[i]%>%
        read_h5()%>%
        tidy(threshold=0.6)%>%
        favstats(x=)
        mutate(Sample = name)%>% 
        mutate(Sample_id = i)%>%
        mutate(threshold=0.6)
     errorB_df <- rbind(errorA_df, m) 
}
```




