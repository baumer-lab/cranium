---
title: "alignment_error_function_CZ"
author: "Crystal Zang"
date: "4/22/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(hdf5r)
library(dplyr)
library(readr)
library(rlang)
library(cranium)
library(broom)
library(tidyverse)
library(gridExtra)
library(mosaic)

#new packages
library(sjstats)
library(grDevices)
library(skimr)
```


# Compare error A for two wt thresholds:
0.9: #error = 6
0.6: #error = 5
```{r}
correctionA_wt_0.9 <- read_csv("correction_results/correctionA_wt_0.9.csv")%>%
  select(-X1)
correctionA_wt_0.6 <- read_csv("correction_results/correctionA_wt_0.6.csv")%>%
  select(-X1)

path = "Sample/WildType"
file_names <- list.files(path, pattern=".h5", full.names=TRUE)


correctionA_wt_0.9_y <- correctionA_wt_0.9 %>%
  filter(y_flipped == 1)
for (i in (1:length(correctionA_wt_0.9_y))){
  j=Sample_id
  c_ro_tidy_brain <- file_names[j]%>%
    read_h5()%>%
    tidy(type, threshold = threshold.n)%>%
    reorient(correctionA=TRUE)
}

ro_tidy_brain<-file_names[j]%>%
    read_h5()%>%
    tidy(type, threshold = threshold.n)%>%
    reorient()

data<-read_h5(file_names[20])

errorA.brain(data)
class(data)
```


# Error B 
```{r}
path = "Sample/YouToo"
path = "Sample/WildType"
file_names <- list.files(path, pattern=".h5", full.names=TRUE)

#ONE SAMPLE
data<-read_h5(file_names[5])%>%
  tidy(threshold=0.6)%>%
  reorient()

brain<-read_h5(file_names[5])

tidy_brain <- brain%>%
  tidy(threshold=0.6)

ro_tidy_brain<-tidy_brain%>%
  reorient()


##wt
brain_wt<-read_h5(file_names[2])

tidy_brain_wt <- brain%>%
  tidy(threshold=0.6)

ro_tidy_brain_wt<-tidy_brain%>%
  reorient()

attr(ro_tidy_brain, "linear_mod")
attr(ro_tidy_brain, "quad_mod")


plot2d(data)
image(data)

z_statistics<-ro_tidy_brain%>%
  skim(z)%>%
  select(stat, formatted)%>%
  spread(stat, formatted)

y_statistics<-data%>%
  skim(y)%>%
  select(stat, formatted)%>%
  spread(stat, formatted)

y_stats<-read_h5(file_names[22])%>%
  tidy(threshold=0.6)%>%
  reorient()%>%
  skim(z)%>%
  select(stat, formatted)%>%
  spread(stat, formatted)

#LOOP
path = "Sample/WildType"
file_names <- list.files(path, pattern=".h5", full.names=TRUE)


errorB_df <- data.frame()

#function
#apply qmodel to all sample, testing for each threshold
is_errorB.brain <- function(data, type="wildtype", threshold.n=0.9){
    mean <- data%>%
        tidy(threshold=threshold.n)%>%
        reorient()%>%
        skim(z)%>%
        select(stat, formatted)%>%
        spread(stat, formatted)%>%
        pull(mean)
    if (abs(mean) >0.1){
      message("Curve in xz plane")
      return(TURE)
    }else{
      message("Correct alignment")
      return(FALSE)
    }
}
is_errorB.brain <- function(data, type="wildtype", threshold.n=0.9){
    mean <- data%>%
        tidy(threshold=threshold.n)%>%
        reorient()%>%
        skim(z)%>%
        select(stat, formatted)%>%
        spread(stat, formatted)%>%
        pull(mean)
    if (abs(mean) >0.1){
      message("Curve in xz plane")
      return(TURE)
    }else{
      message("Correct alignment")
      return(FALSE)
    }
}

is_errorB.tbl_brain <- function(data, type="wildtype", threshold.n=0.9){
    mean <- data%>%
        reorient()%>%
        skim(z)%>%
        select(stat, formatted)%>%
        spread(stat, formatted)%>%
        pull(mean)%>%
      as.numeric()
    if (abs(mean) >0.1){
      message("Curve in xz plane")
      return(TURE)
    }else{
      message("Correct alignment")
      return(FALSE)
    }
}

mean <- mean%>%
  as.numeric()

is_errorB.tbl_brain(tidy_brain)

mean <- data%>%
        reorient()%>%
        skim(z)%>%
        select(stat, formatted)%>%
        spread(stat, formatted)%>%
        pull(mean)




is_errorB.brain <- function(data, type="wildtype", threshold.n=0.9){
  ro_tidy_brain <- data%>%
    tidy(type, threshold = threshold.n)%>%
    reorient()
  ro_model <- attr(ro_tidy_brain, "linear_mod")  #model applied on reoriented data
  quad.coeff = round((summary(ro_model)$coefficients["I(x^2)", "Estimate"]), 4)

  if (quad.coeff < 0) {
    message("Y Axis is flipped")
    return(TRUE)
  } else{
    message("Correct alignment")
    return(FALSE)
  }
}

```


```{r}
class(brain)
library(pracma)
rotate_counter_clockwise <- function(x){ apply(t(x),2, rev)}
brain_matrix <- as.matrix(brain)
brain_rotate <- rotate_counter_clockwise(brain_matrix)


brain_rotate_array<-as.array(brain_rotate)

tidy_brain<-tidy(brain_rotate_array)
ro_tidy_brain

```




