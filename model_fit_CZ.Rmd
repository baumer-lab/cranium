---
title: "model_fit_CZ"
author: "CZ"
date: "4/4/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(hdf5r)
library(dplyr)
library(rlang)
library(BiocInstaller)
library(rhdf5)
library(cranium)
library(broom)
library(tidyverse)
library(gridExtra)
library(mosaic)
```


# Data: Wild Type 
```{r}
ls_wt <- c("Wild Type_101", "Wild Type_102")
ls_wt

file_ls_wt =c("0")
file_ls_wt

for (i in (1:length(ls_wt))) {
  file_ls_wt[i] = paste("file", ls_wt[i])
}

file_ls_wt

file_ls_wt[1]<- "Sample/AT_wildtype_101_Probabilities.h5"
file_ls_wt[2] <-  "Sample/AT_wildtype_102_Probabilities.h5"
#file_ls[3] <-  "Sample/AT_wildtype_104_Probabilities.h5"



file_ls_wt

#defalt threshol = 0.9
brain_ls_wt <- list()
for (i in (1:length(ls_wt))) {
  brain_ls_wt[[i]] <- file_ls_wt[i] %>%
  read_h5()
}
```


# Data: You too
```{r}
ls_youtoo <- c("You_Too_01", "You_Too_02")

file_ls_youtoo =c("0")
file_ls_youtoo

for (i in (1:length(ls_youtoo))) {
  file_ls_youtoo[i] = paste("file", ls_youtoo[i])
}

file_ls_youtoo

file_ls_youtoo[1] <- "Sample/AT_01_Probabilities.h5"
file_ls_youtoo[2] <- "Sample/AT_02_Probabilities.h5"
#file_ls[6] <- "Sample/AT_03_Probabilities.h5"
#file_ls[7] <- "Sample/AT_04_Probabilities.h5"
#file_ls[8] <- "Sample/AT_06_Probabilities.h5"
#file_ls[9] <- "Sample/AT_21_Probabilities.h5"


file_ls_youtoo
#threshold = 0.7
brain_ls_youtoo <- list()
for (i in (1:length(file_ls_youtoo))) {
  brain_ls_youtoo[[i]] <- file_ls_youtoo[i] %>%
  read_h5()
}

```

# Function (Final)
Requires: 
1.data to be in brain class type.
2.type to be either "wildtype" or "youtoo"
```{r}
#Fit quadratic model, output is the adjusted r_square

qmodel.brain<- function(data, type){
  if (type == "wildtype"){
    tidy_brain <- data%>%
  tidy(threshold = 0.9)
  }
  if(type== "youtoo"){
    tidy_brain <- data%>%
    tidy(threshold = 0.5)
  }
  model <- lm(y ~ I(x^2) + x, data = tidy_brain)
  r_2 = round(summary(model)$r.squared,3)
  num_signal = nrow(tidy_brain)
  #return(list(r_2, num_signal))
  return(data.frame(type, r_2, num_signal))
}
```


# Use qmodel function on the youtoo data
```{r}
model_df <- data.frame()
for (i in (1:length(ls_youtoo))) {
  m <- qmodel.brain(brain_ls_youtoo[[i]], "youtoo")%>%
          mutate(sample = ls_youtoo[i])
  model_df <- rbind(model_df, m)
}
View(model_df)
```

# Experiment 
Generate two tables for wildtype and youtoo for threshold, $r^2$, number of signals comparison.
```{r}

x0 = 0.9
list <- seq(x0, 0.99, 0.03)

#Calculate fitted r square
fit_value<-c()
for (i in (1:length(list))){
   fit_value[i]<- round(model_fit(list[i], brain_ls_youtoo[[1]]),4)
}
fit_value

#Calculate number signals
num_signals<- c()
for (i in (1:length(list))){
   num_signals[i]<- model_num_signal(list[i], brain_ls_wt[[1]])
}
num_signals
  
fitted_threshold_tb <- data.frame(list, fit_value, num_signals)
colnames(fitted_threshold_tb)[1] = "threshold.YouToo"
colnames(fitted_threshold_tb)[2] = "r_square.YouToo"
colnames(fitted_threshold_tb)[3] = "num_signals.YouToo"

df2
fitted_threshold_tb_wt <- data.frame(df2, num_signals)
colnames(fitted_threshold_tb_wt)[1] = "threshold.WT"
colnames(fitted_threshold_tb_wt)[2] = "r_square.WT"
colnames(fitted_threshold_tb_wt)[3] = "num_signals.WT"
```


