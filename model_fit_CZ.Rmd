---
title: "model_fit_CZ"
author: "CZ"
date: "4/4/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(hdf5r)
library(dplyr)
library(rlang)
library(BiocInstaller)
library(rhdf5)
library(cranium)
library(broom)
library(tidyverse)
library(gridExtra)
library(mosaic)
```

```{r}
library("aws.s3")
h1<-get_object("https://s3.us-east-2.amazonaws.com/deltascope/AT_04_Probabilities.h5")

```


# Tidy Function (Final:4/8, 7:30 pm)
```{r}
tidy.brain <- function(x, type="wildtype", threshold.n=0.9, ...) {
  if (type=="youtoo"){
      if(threshold.n != 0.9){
        threshold = threshold.n   
        print(paste0("Set threshold: ", threshold))
      }else{
        threshold = 0.5
        print("Default You-Too threshold: 0.5")
      }
  }else{
      if(threshold.n != 0.9) {  #if threshold is not default, use the input threshold
        threshold = threshold.n 
        print(paste0("Set threshold: ", threshold))
      }else{
        threshold = 0.9
        print(("Default threshold: 0.9"))
      }
  }
    res <- x %>%
    as.data.frame.table() %>%
    mutate(x = as.integer(Var1) * 0.13,
           y = as.integer(Var2) * 0.13,
           z = as.integer(Var3) * 0.21) %>%
    select(x, y, z, Freq) %>%
    tibble::as_tibble() %>%
    mutate(gray_val = grDevices::gray(1 - Freq)) %>%
    filter(Freq > threshold)
    class(res) <- append("tbl_brain", class(res))
  return(res)
}

#test
#test<-tidy(brain_ls_wt[[1]], type= "wildtype", threshold.n = 0.9)
```


#Read file: Wild Type. Output class type: brain.
```{r}
path = "Sample/WildType"
file_names <- list.files(path, pattern=".h5", full.names=TRUE)
brain_ls_wt <- list()
for (i in (1:length(file_names))) {
  brain_ls_wt[[i]] <- file_names[i] %>%
  read_h5()
}

```

#Read file: You Too. Output class type: brain.
```{r}
path = "Sample/YouToo"
file_names <- list.files(path, pattern=".h5", full.names=TRUE)


brain_ls_youtoo <- list()
for (i in (1:length(file_names))) {
  brain_ls_youtoo[[i]] <- file_names[i] %>%
  read_h5()
}

```



# Function--model (Final:4/8, 7:30 pm)
Requires: 
1.data to be in brain class type.
2.type to be either "wildtype" or "youtoo"
```{r}
#Fit quadratic model, output is the adjusted r_square
qmodel.brain<- function(data, type="wildtype", threshold.n=0.9){
  if (type == "wildtype"){  
    tidy_brain <- data %>%
    tidy(type="wildtype", threshold = threshold.n )
    ro_tidy_brain<- reorient(tidy_brain)
  }
  if(type== "youtoo"){  
    tidy_brain <- data%>%
    tidy(type="youtoo", threshold = threshold.n)
    ro_tidy_brain<- reorient(tidy_brain)

  }
  model <- lm(y ~ I(x^2) + x, data = tidy_brain) #model applied on original data
#  RMLSE = model %>%
#    fitted%>% 
#              mutate(residual = y- .fitted, residual_sq = residual^2) %>% 
#              summarize(MLSE = mean(residual_sq),RMLSE = sqrt(MLSE)) %>% 
#              pull(RMLSE)
  ro_model <- attr(ro_tidy_brain, "quad_mod")  #model applied on reoriented data
  
  sum_tb<- ro_model %>%
    broom::glance() %>%
    mutate(num_signal = nrow(tidy_brain),
           r_2 = round(summary(model)$r.squared, 3),#original r square
           ro_r_2 = round(summary(ro_model)$r.squared,3), #reoriented r square
#           RMLSE = RMLSE,
           quad_coeff = round(summary(ro_model)$coefficients[3, 1],4)) #quadratic coefficient)
                  #return(data.frame(type, r_2, num_signal))
  return(sum_tb)
}

#test
qmodel.brain(data=brain_ls_youtoo[[2]], type= "youtoo")
#qmodel.brain(data=brain_ls_wt[[1]], type= "wildtype", threshold.n = 0.1)
#qmodel.brain(data=brain_ls_wt[[1]], type= "wildtype")

```

# Data: Wild Type 
```{r}
ls_wt <- c("Wild Type_101", "Wild Type_102")
ls_wt

file_ls_wt =c("0")
file_ls_wt

for (i in (1:length(ls_wt))) {
  file_ls_wt[i] = paste("file", ls_wt[i])
}

file_ls_wt

file_ls_wt[1]<- "Sample/AT_wildtype_101_Probabilities.h5"
file_ls_wt[2] <-  "Sample/AT_wildtype_102_Probabilities.h5"
#file_ls[3] <-  "Sample/AT_wildtype_104_Probabilities.h5"



file_ls_wt

#defalt threshol = 0.9
brain_ls_wt <- list()
for (i in (1:length(ls_wt))) {
  brain_ls_wt[[i]] <- file_ls_wt[i] %>%
  read_h5()
}
```


# Data: You too
```{r}
ls_youtoo <- c("You_Too_01", "You_Too_02")

file_ls_youtoo =c("0")
file_ls_youtoo

for (i in (1:length(ls_youtoo))) {
  file_ls_youtoo[i] = paste("file", ls_youtoo[i])
}

file_ls_youtoo

file_ls_youtoo[1] <- "Sample/AT_01_Probabilities.h5"
file_ls_youtoo[2] <- "Sample/AT_02_Probabilities.h5"
#file_ls[6] <- "Sample/AT_03_Probabilities.h5"
#file_ls[7] <- "Sample/AT_04_Probabilities.h5"
#file_ls[8] <- "Sample/AT_06_Probabilities.h5"
#file_ls[9] <- "Sample/AT_21_Probabilities.h5"


file_ls_youtoo
#threshold = 0.7
brain_ls_youtoo <- list()
for (i in (1:length(file_ls_youtoo))) {
  brain_ls_youtoo[[i]] <- file_ls_youtoo[i] %>%
  read_h5()
}

```


```{r}
#breakdown the steps of the function
data=brain_ls_youtoo[[2]]
tidy_brain <- data %>%
 tidy(type="youtoo")
class(tidy_brain)
ro_tidy_brain<- reorient(tidy_brain)

model <- lm(y ~ I(x^2) + x, data = tidy_brain) #model applied on original data
r_2 = round(summary(model)$r.squared, 3) #original r square
ro_model <- attr(ro_tidy_brain, "quad_mod") #model applied on reoriented data
ro_r_2 = round(summary(ro_model)$r.squared,3) 

glance(ro_model)
quad_coeff = summary(quad_mod)$coefficients[3, 1]

RMLSE <- fitted%>% 
      mutate(residual = y- .fitted, residual_sq = residual^2) %>% 
      summarize(MLSE = mean(residual_sq),RMLSE = sqrt(MLSE)) %>% 
      pull(RMLSE)

#Extract pca model
#str(ro_tidy_brain)
quad_mod <- attr(ro_tidy_brain, "quad_mod")
fitted<-quad_mod%>%
  augment()
rmsle(fitted$y, fitted$.fitted)

 
 
summary(quad_mod)

# glance(quad_mod)



```

# Use qmodel function on the youtoo data
```{r}
model_df <- data.frame()
for (i in (1:length(ls_youtoo))) {
  m <- qmodel.brain(brain_ls_youtoo[[i]], type="youtoo")%>%
          mutate(sample = ls_youtoo[i])
  model_df <- rbind(model_df, m)
}
View(model_df)
```




```{r}
#Test tidy function
data=brain_ls_youtoo[[1]]

tidy_youtoo_sample<-tidy(data, type = "d") #"Default threshold: 0.9"

tidy_youtoo_sample<-tidy(data, threshold.n=0.3) #"Set threshold:0.3"
                         
tidy_youtoo_sample<-tidy(data, threshold.n=0.3, type = "youtoo") #Works

tidy_youtoo_sample<-tidy(data) #"Default Wild Type threshold: 0.9"


tidy_youtoo_sample<-tidy(data, type == "wildtype") #"Default type: Wild type. Default threshold: 0.9"

class(tidy_youtoo_sample)

#You too data
ls_youtoo <- c("You_Too_01", "You_Too_02")
file_ls_youtoo =c("0")

for (i in (1:length(ls_youtoo))) {
  file_ls_youtoo[i] = paste("file", ls_youtoo[i])
}

file_ls_youtoo[1] <- "Sample/AT_01_Probabilities.h5"
file_ls_youtoo[2] <- "Sample/AT_02_Probabilities.h5"
#file_ls[6] <- "Sample/AT_03_Probabilities.h5"
#file_ls[7] <- "Sample/AT_04_Probabilities.h5"
#file_ls[8] <- "Sample/AT_06_Probabilities.h5"
#file_ls[9] <- "Sample/AT_21_Probabilities.h5"

#Read and tidy
tidy_brain_ls_youtoo <- list()
for (i in (1:length(file_ls_youtoo))) {
  tidy_brain_ls_youtoo[[i]] <- file_ls_youtoo[i] %>%
  read_h5() %>%
 # tidy( threshold=0.5)
  tidy(type="youtoo")
}
#Reorient
ro_brain_ls_youtoo<-tidy_brain_ls_youtoo%>%
lapply(reorient)

#Plot
plotlist_youtoo <- list()
for (i in (1:length(ls_youtoo))){
  plotlist_youtoo[[i]] <- plot2d(ro_brain_ls_youtoo[[i]], title=paste("Sample", ls_youtoo[i]))
   # plot(plotlist[[i]])
   # dev.off
}



model_df <- data.frame()
for (i in (1:length(ls_youtoo))) {
  m <- qmodel.brain(brain_ls_youtoo[[i]], type="youtoo")%>%
          mutate(sample = ls_youtoo[i])
  model_df <- rbind(model_df, m)
}
View(model_df)


```



# Experiment(Old function) 
Generate two tables for wildtype and youtoo for threshold, $r^2$, number of signals comparison.
```{r}
x0 = 0.9
list <- seq(x0, 0.99, 0.03)

#Calculate fitted r square
fit_value<-c()
for (i in (1:length(list))){
   fit_value[i]<- round(model_fit(list[i], brain_ls_youtoo[[1]]), 4)
}
fit_value

#Calculate number signals
num_signals<- c()
for (i in (1:length(list))){
   num_signals[i]<- model_num_signal(list[i], brain_ls_wt[[1]])
}
num_signals
  
fitted_threshold_tb <- data.frame(list, fit_value, num_signals)
colnames(fitted_threshold_tb)[1] = "threshold.YouToo"
colnames(fitted_threshold_tb)[2] = "r_square.YouToo"
colnames(fitted_threshold_tb)[3] = "num_signals.YouToo"

df2
fitted_threshold_tb_wt <- data.frame(df2, num_signals)
colnames(fitted_threshold_tb_wt)[1] = "threshold.WT"
colnames(fitted_threshold_tb_wt)[2] = "r_square.WT"
colnames(fitted_threshold_tb_wt)[3] = "num_signals.WT"
```


