---
title: "model_fit_CZ"
author: "CZ"
date: "4/4/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(hdf5r)
library(dplyr)
library(rlang)
library(cranium)
library(broom)
library(tidyverse)
library(gridExtra)
library(mosaic)

#new packages
library(sjstats)
```

```{r}
#library("aws.s3")
#h1<-get_object("https://s3.us-east-2.amazonaws.com/deltascope/AT_04_Probabilities.h5")
```


# Tidy Function (Final:4/9, 4:30 pm)
```{r}
tidy.brain <- function(x, type="wildtype", threshold.n=0.9, ...) {
  if (type=="youtoo"){
      if(threshold.n != 0.9){
        threshold = threshold.n   
        print(paste0("Set threshold: ", threshold))
      }else{
        threshold = 0.5
        print("Default You-Too threshold: 0.5")
      }
  }else{
      if(threshold.n != 0.9) {  #if threshold is not default, use the input threshold
        threshold = threshold.n 
        print(paste0("Set threshold: ", threshold))
      }else{
        threshold = 0.9
        print(("Default threshold: 0.9"))
      }
  }
    res <- x %>%
    as.data.frame.table() %>%
    mutate(x = as.integer(Var1) * 0.13,
           y = as.integer(Var2) * 0.13,
           z = as.integer(Var3) * 0.21) %>%
    select(x, y, z, Freq) %>%
    tibble::as_tibble() %>%
    mutate(gray_val = grDevices::gray(1 - Freq)) %>%
    filter(Freq > threshold)
    class(res) <- append("tbl_brain", class(res))
  return(res)
}

#test
#test<-tidy(brain_ls_wt[[1]], type= "wildtype", threshold.n = 0.9)
```


# Function--model (Final:4/9, 4:30 pm)
Requires: 
1.data to be in brain class type.
2.type to be either "wildtype" or "youtoo"
```{r}
#Fit quadratic model, output is the adjusted r_square
qmodel.brain<- function(data, type="wildtype", threshold.n=0.9){
  if (type == "wildtype"){  
    tidy_brain <- data %>%
    tidy(type="wildtype", threshold = threshold.n )
    ro_tidy_brain<- reorient(tidy_brain)
  }
  if(type== "youtoo"){  
    tidy_brain <- data%>%
    tidy(type="youtoo", threshold = threshold.n)
    ro_tidy_brain<- reorient(tidy_brain)

  }
  model <- lm(y ~ I(x^2) + x, data = tidy_brain) #model applied on original data
  ro_model <- attr(ro_tidy_brain, "quad_mod")  #model applied on reoriented data
  mean.fitted = mean(ro_model$fitted.values)
  #sigma=sjstats::rse(ro_model). RSE: residual standard error
  #RSE = sjstats::rse(ro_model)
  sum_tb<- ro_model %>%
    broom::glance() %>%
    mutate(num.signal = nrow(tidy_brain),
           adj.r.squared.original = round(summary(model)$adj.r.squared, 3),#original r square
           quad.coeff = round(summary(ro_model)$coefficients[3, 1],4),
           RMSE = sjstats::rmse(ro_model) ) 
  return(sum_tb)
}

#test
#sum_tb <- qmodel.brain(data=brain_ls_youtoo[[2]], type= "youtoo")
#qmodel.brain(data=brain_ls_wt[[1]], type= "wildtype", threshold.n = 0.1)
#qmodel.brain(data=brain_ls_wt[[1]], type= "wildtype")

```

#Read file: Wild Type. Output class type: brain.
```{r eval=FALSE, include=FALSE}
path = "Sample/WildType"
file_names <- list.files(path, pattern=".h5", full.names=TRUE)

brain_ls_wt.1 <- list()  #Brain data files are stored in a list: brain_ls_wt
name_wt.1 <- list()  #Name of the files are stored in a list: name_wt
#file_names.1 <-  file_names [1:8]  #select files

#file_names.1 <-  file_names [9:19]  #select files
#file_names.1 <-  file_names [20:30]  #select files
file_names.1 <-  file_names [31:43]  #select files
for (i in (1:length(file_names.1))) {
  brain_ls_wt.1[[i]] <- file_names.1[i] %>%
  read_h5()
  name_wt.1[i] <- sub("_Probabilities.h5", "", file_names.1[i])
}

#Fit model
qmodel_sum_tb_wt.1<- data.frame()
m <- list()
for (i in (1:length(brain_ls_wt.1))) {
  m<- qmodel.brain(brain_ls_wt.1[[i]])%>%
    mutate(sample = name_wt.1[[i]])
  qmodel_sum_tb_wt.1 <- rbind(qmodel_sum_tb_wt.1, m)
}

#write.csv(qmodel_sum_tb_wt.1, file = "visualization_results/qmodel_sum_tb_wt.4.csv", row.names=F)
```

# Read file: You Too. Output class type: brain.
```{r eval=FALSE, include=FALSE}
path = "Sample/YouToo"

file_names <- list.files(path, pattern=".h5", full.names=TRUE)
file_names[11]
brain_ls_youtoo.1 <- list()  #Brain data files are stored in a list: brain_ls_wt
name_youtoo.1 <- list()  #Name of the files are stored in a list: name_wt
#file_names.1 <-  file_names [1:35]  #select files

file_names.1 <- youtoo_y.flipped_name

for (i in (1:length(file_names.1))) {
  brain_ls_youtoo.1[[i]] <- file_names.1[i] %>%
  read_h5()
  name_youtoo.1[i] <- sub("_Probabilities.h5", "", file_names.1[i])
}

#Fit model
qmodel_sum_tb_youtoo.1<- data.frame()
m <- list()
for (i in (1:length(brain_ls_youtoo.1))) {
  m<- qmodel.brain(brain_ls_youtoo.1[[i]])%>%
    mutate(sample = name_youtoo.1[[i]])
  qmodel_sum_tb_youtoo.1 <- rbind(qmodel_sum_tb_youtoo.1, m)
}

#write.csv(qmodel_sum_tb_youtoo.1, file = "visualization_results/qmodel_sum_tb_youtoo.1.csv", row.names=F)

```





# Breakdown the steps of the function--qmodel
```{r eval=FALSE, include=FALSE}
data=brain_ls_youtoo[[2]]
tidy_brain <- data %>%
 tidy(type="youtoo")
class(tidy_brain)
ro_tidy_brain<- reorient(tidy_brain)

model <- lm(y ~ I(x^2) + x, data = tidy_brain) #model applied on original data
r_2 = round(summary(model)$r.squared, 3) #original r square
ro_model <- attr(ro_tidy_brain, "quad_mod") #model applied on reoriented data
ro_r_2 = round(summary(ro_model)$r.squared,3) 

glance(ro_model)
quad_coeff = summary(quad_mod)$coefficients[3, 1]

RMLSE <- fitted%>% 
      mutate(residual = y- .fitted, residual_sq = residual^2) %>% 
      summarize(MLSE = mean(residual_sq),RMLSE = sqrt(MLSE)) %>% 
      pull(RMLSE)

#Extract pca model
#str(ro_tidy_brain)
quad_mod <- attr(ro_tidy_brain, "quad_mod")
fitted<-quad_mod%>%
  augment()
rmsle(fitted$y, fitted$.fitted)
summary(quad_mod)

```

# Apply qmodel on sample data 
```{r}
#youtoo data

qmodel_sum_tb<- data.frame()
m <- list()
for (i in (1:length(brain_ls_youtoo))) {
  m<- qmodel.brain(brain_ls_youtoo[[i]], type = "youtoo")%>%
    mutate(sample = name_youtoo[[i]])
  qmodel_sum_tb <- rbind(qmodel_sum_tb, m)
}

#wildtype
qmodel_sum_tb_wt.1<- data.frame()
m <- list()
for (i in (1:length(brain_ls_wt.1))) {
  m<- qmodel.brain(brain_ls_wt.1[[i]])%>%
    mutate(sample = name_wt.1[[i]])
  qmodel_sum_tb_wt.1 <- rbind(qmodel_sum_tb_wt.1, m)
}

write(qmodel_sum_tb_wt.1, file = "qmodel_sum_tb_wt.1.csv")
```



# Plot
```{r}
#Plot
plotlist_youtoo <- list()
for (i in (1:length(ls_youtoo))){
  plotlist_youtoo[[i]] <- plot2d(ro_brain_ls_youtoo[[i]], title=paste("Sample", ls_youtoo[i]))
   # plot(plotlist[[i]])
   # dev.off
}
```




